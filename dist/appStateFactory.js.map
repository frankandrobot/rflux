{"version":3,"sources":["appStateFactory.js"],"names":["appStateFactory","stores","rawStores","sagas","rawSagas","middleware","length","Error","InitialAppDispatcher","dispatch","emit","Middleware","rawMiddleware","AppDispatcher","attachMiddleware","_createStores","_createSagas","appStateObservable","_createAppStateObservable","map","setState","state","_setupStoreObs","_setupSagaObs","AppState","_storesToState","_sagasToState","s","storeStatesWithSideEffectsObservables","x","stateWithSideEffectsObservable","combine","observables","reduce","i","Object","assign","name","store","saga","actionFunctions","resultObservables","forEach","onValue","sideEffects","setTimeout","sideEffect","keys","_sagas","obs","undefined"],"mappings":";;;;;;;;kBAsBwBA,e;;AAtBxB;;;;AAEA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAGA;;;;;;;;;;;;;;AAce,SAASA,eAAT,OAKV;AAAA,yBAHDC,MAGC;AAAA,MAHOC,SAGP,+BAHmB,EAGnB;AAAA,wBAFDC,KAEC;AAAA,MAFMC,QAEN,8BAFiB,EAEjB;AAAA,6BADDC,UACC;AAAA,MADDA,UACC,mCADY,EACZ;;;AAEH;AACA,MAAIH,UAAUI,MAAV,KAAqB,CAAzB,EAA4B;AAC1B,UAAM,IAAIC,KAAJ,CAAU,6BAAV,CAAN;AACD;AACD,MAAMC,uBAAuB,oCAA7B;AACA,MAAMC,WAAW,SAAXA,QAAW;AAAA,WAAaD,qBAAqBE,IAArB,uCAAb;AAAA,GAAjB;AACA,MAAMC,aAAa,iCAAkB,EAACF,kBAAD,EAAWG,eAAeP,UAA1B,EAAlB,CAAnB;AACA,MAAMQ,gBAAgBF,WAAWG,gBAAX,CAA4B,EAACD,eAAeL,oBAAhB,EAA5B,CAAtB;;AAEA,MAAMP,SAASc,cAAc,EAACb,oBAAD,EAAYW,4BAAZ,EAAd,CAAf;AACA,MAAMV,QAAQa,aAAa,EAACZ,kBAAD,EAAWS,4BAAX,EAAb,CAAd;AACA,MAAMI,qBACJC,0BAA0B,EAACjB,cAAD,EAA1B;AACA;AACA;AACA;AAHA,GAIGkB,GAJH,CAIO,iBAAS;AAAER,eAAWS,QAAX,CAAoBC,KAApB,EAA4B,OAAOA,KAAP;AAAc,GAJ5D,CADF;;AAOAC,iBAAe,EAACrB,cAAD,EAASY,4BAAT,EAAf;AACAU,gBAAc,EAACpB,YAAD,EAAd;;AAEA,MAAMqB;AACJP;AADI,KAEDQ,eAAe,EAACxB,cAAD,EAAf,CAFC,EAGDyB,cAAc,EAACvB,YAAD,EAAd,CAHC,CAAN;;AAMA,SAAO;AACLqB,sBADK;AAELX;AAFK,GAAP;AAID;;AAED,SAASE,aAAT,QAAmD;AAAA,MAA3Bb,SAA2B,SAA3BA,SAA2B;AAAA,MAAhBW,aAAgB,SAAhBA,aAAgB;;AACjD,SAAOX,UAAUiB,GAAV,CAAc;AAAA,WAAK,2BAAYQ,CAAZ,EAAed,aAAf,CAAL;AAAA,GAAd,CAAP;AACD;;AAED,SAASG,YAAT,QAAiD;AAAA,MAA1BZ,QAA0B,SAA1BA,QAA0B;AAAA,MAAhBS,aAAgB,SAAhBA,aAAgB;;AAC/C,SAAOT,SAASe,GAAT,CAAa;AAAA,WAAK,2BAAYQ,CAAZ,EAAed,aAAf,CAAL;AAAA,GAAb,CAAP;AACD;;AAED,SAASK,yBAAT,QAA6C;AAAA,MAATjB,MAAS,SAATA,MAAS;;AAC3C;AACA,MAAM2B,wCAAwC3B,OAAOkB,GAAP,CAAW;AAAA,WAAKU,EAAEC,8BAAP;AAAA,GAAX,CAA9C;;AAEA;AACA,SAAO,gBAAMC,OAAN;AACL;AACAH,uCAFK;AAGL;AACA;AAAA,sCAAII,WAAJ;AAAIA,iBAAJ;AAAA;;AAAA,WAAoBA,YAAYC,MAAZ,CAClB,UAAChB,kBAAD,EAAqBI,KAArB,EAA4Ba,CAA5B;AAAA,aAAkCC,OAAOC,MAAP,CAChCnB,kBADgC,2BAE3BhB,OAAOiC,CAAP,EAAUG,IAFiB,EAERhB,MAAMA,KAFE,EAAlC;AAAA,KADkB,EAKlB,EALkB,CAApB;AAAA,GAJK,CAAP;AAYD;;AAED,SAASI,cAAT,QAAkC;AAAA,MAATxB,MAAS,SAATA,MAAS;;AAChC,SAAOA,OAAOgC,MAAP,CAAc,UAACZ,KAAD,EAAQiB,KAAR;AAAA,wBAAuBjB,KAAvB,EAAiCiB,MAAMA,KAAvC;AAAA,GAAd,EAA8D,EAA9D,CAAP;AACD;;AAED,SAASZ,aAAT,QAAgC;AAAA,MAARvB,KAAQ,SAARA,KAAQ;;AAC9B;AACA,SAAOA,MAAM8B,MAAN,CAAa,UAACZ,KAAD,EAAQkB,IAAR;AAAA,wBAAsBlB,KAAtB,EAAgCkB,KAAKC,eAArC,EAAyDD,KAAKE,iBAA9D;AAAA,GAAb,EAAgG,EAAhG,CAAP;AACD;;AAED,SAASnB,cAAT,QAAiD;AAAA,MAAxBrB,MAAwB,SAAxBA,MAAwB;AAAA,MAAhBY,aAAgB,SAAhBA,aAAgB;;AAC/C;AACAZ,SAAOyC,OAAP,CAAe;AAAA,WAASJ,MAAMR,8BAAN,CAAqCa,OAArC,CAA6C;AAAA,aACnE,CAACtB,MAAMuB,WAAN,IAAqB,EAAtB,EAA0BF,OAA1B,CACE;AAAA,eAAcG,WAAW;AAAA,iBAAMhC,cAAcH,IAAd,CAAmBoC,UAAnB,CAAN;AAAA,SAAX,EAAiD,CAAjD,CAAd;AAAA,OADF,CADmE;AAAA,KAA7C,CAAT;AAAA,GAAf;AAKD;;AAED,SAASvB,aAAT,QAAgC;AAAA,MAARpB,KAAQ,SAARA,KAAQ;;AAC9B;AACAA,QAAMuC,OAAN,CAAc;AAAA,WACZP,OAAOY,IAAP,CAAYC,OAAOhB,WAAnB,EAAgCU,OAAhC,CAAwC;AAAA,aAAOM,OAAOhB,WAAP,CAAmBiB,GAAnB,EAAwBN,OAAxB,CAAgC;AAAA,eAAMO,SAAN;AAAA,OAAhC,CAAP;AAAA,KAAxC,CADY;AAAA,GAAd;AAGD","file":"appStateFactory.js","sourcesContent":["import Kefir from 'kefir'\n\nimport createAppDispatcher from './appdispatcher/createAppDispatcher'\nimport createStore from './stores/createStore'\nimport createSagas from './stores/createSagas'\nimport middlewareFactory from './redux/middlewareFactory'\n\n\n/**\n * A store consists of:\n * - a name (channel)\n * - map of ActionTypes\n * - map of Reducers indexed by ActionType\n * - map of ActionFunctions indexed by ActionType\n *\n * A middleware is function with the following signature:\n * store => next => action\n *\n * @param {Stores[]} stores\n * @param {Sagas[]} sagas\n * @param {Middleware[]} middleware\n */\nexport default function appStateFactory(\n  {\n    stores: rawStores = [],\n    sagas: rawSagas = [],\n    middleware = []\n  }) {\n\n  /* eslint-disable no-use-before-define */\n  if (rawStores.length === 0) {\n    throw new Error('You didn\\'t add any stores!')\n  }\n  const InitialAppDispatcher = createAppDispatcher()\n  const dispatch = (...args) => InitialAppDispatcher.emit(...args)\n  const Middleware = middlewareFactory({dispatch, rawMiddleware: middleware})\n  const AppDispatcher = Middleware.attachMiddleware({AppDispatcher: InitialAppDispatcher})\n\n  const stores = _createStores({rawStores, AppDispatcher})\n  const sagas = _createSagas({rawSagas, AppDispatcher})\n  const appStateObservable =\n    _createAppStateObservable({stores})\n    // inject the state back into Middleware, so that getState works. Unfortunately, in kefirjs, there is\n    // no way to do a side effect w/o activating the stream. So we use `map` for side effects (which is\n    // technically an antipattern).\n      .map(state => { Middleware.setState(state); return state })\n\n  _setupStoreObs({stores, AppDispatcher})\n  _setupSagaObs({sagas})\n\n  const AppState = {\n    appStateObservable,\n    ..._storesToState({stores}),\n    ..._sagasToState({sagas})\n  }\n\n  return {\n    AppState,\n    AppDispatcher\n  }\n}\n\nfunction _createStores({rawStores, AppDispatcher}) {\n  return rawStores.map(s => createStore(s)(AppDispatcher))\n}\n\nfunction _createSagas({rawSagas, AppDispatcher}) {\n  return rawSagas.map(s => createSagas(s)(AppDispatcher))\n}\n\nfunction _createAppStateObservable({stores}) {\n  // first create the new appStateObservable\n  const storeStatesWithSideEffectsObservables = stores.map(x => x.stateWithSideEffectsObservable)\n\n  // then combine these into the appStateObservable\n  return Kefir.combine(\n    // this fires when any of the store state observables change\n    storeStatesWithSideEffectsObservables,\n    // this combines all the store states into a single state\n    (...observables) => observables.reduce(\n      (appStateObservable, state, i) => Object.assign(\n        appStateObservable,\n        {[`${stores[i].name}`]: state.state}\n      ),\n      {}\n    )\n  )\n}\n\nfunction _storesToState({stores}) {\n  return stores.reduce((state, store) => ({...state, ...store.store}), {})\n}\n\nfunction _sagasToState({sagas}) {\n  // add action functions and result observables to app state\n  return sagas.reduce((state, saga) => ({...state, ...saga.actionFunctions, ...saga.resultObservables}), {})\n}\n\nfunction _setupStoreObs({stores, AppDispatcher}) {\n  // setup one-way data flow + side effects\n  stores.forEach(store => store.stateWithSideEffectsObservable.onValue(state =>\n    (state.sideEffects || []).forEach(\n      sideEffect => setTimeout(() => AppDispatcher.emit(sideEffect), 0)\n    )\n  ))\n}\n\nfunction _setupSagaObs({sagas}) {\n  // setup one-way data flow\n  sagas.forEach(_sagas =>\n    Object.keys(_sagas.observables).forEach(obs => _sagas.observables[obs].onValue(() => undefined))\n  )\n}\n\n\n\n"]}